# Abstract

提出了PINGPONG，一个可以从网络流量中自动提取设备事件（例如，灯泡打开/关闭）的包级签名的工具。

我们能够 (1) 自动提取以前未知的签名，这些**签名由数据包长度和方向的简单序列组成**；(2) **使用这些签名检测设备或特定事件**，平均召回率超过97%；(3) 显示这些**签名**在现实世界的数亿个网络流量数据包中是**独一无二的**；(4) 显示我们的方法也**适用于公开可用的数据集**；以及(5) 证明其在不同环境中的稳健性：由本地和远程智能手机以及家庭自动化系统触发的事件。

# 简介

现有的被动推理技术有其局限性。大多数**只能识别设备类型和是否有设备活动**（事件），但不能识别事件或命令的确切类型。

我们用不同的智能家居设备进行实验，即来自16个流行供应商的19个流行的Wi-Fi和Zigbee设备，包括智能插头、灯泡、恒温器、家庭安全系统等。

我们观察到，设备上的事件通常会导致**设备、智能手机和云端服务器之间的通信**，这些通信包含**具有可预测长度的数据包对**。

不同设备类型和事件的**数据包长度是不同的**，因此，可以用来推断设备和发生的具体事件类型。在这一观察的基础上，我们能够确定新的数据包级签名（或简称签名），这些签名仅由**智能家居设备流量中的几个数据包的长度和方向**组成。

我们表明，这些签名：(1) 可以以自动和系统的方式提取，而无需事先了解设备的行为；(2) 可以用来推断细粒度的信息，如事件类型。(3) 对应于**各种不同的事件（例如，"切换开/关 "和 "强度"/"颜色"**）；以及 (4) 与先前的（例如，基于统计的、体积的）方法相比有许多优势。

**本文有以下贡献：**

**新的数据包级别的签名。**我们发现了新的物联网设备签名，这些签名简单而直观：它们由**特定长度的短序列（通常是2-6个）数据包组成**，在设备、智能手机和云之间交换。这些签名是有效的。
1）它们以超过97%的平均召回率**检测事件的发生**，超过了最先进的技术（见第二节和第五节B）。
2）它们是独一无二的：我们观察到一个**低的假阳性率**（FPR）。
3）它们具有广泛的设备特征：（i）我们为19种设备中的18种提取了签名；（ii）我们从公共数据集[39]中提取了另外**21种设备**的签名，包括**更复杂的设备**，如语音指令设备、智能电视，甚至是冰箱（见V-F节）。

4）它们在各种不同的环境中都是稳健的：（i）我们从测试平台实验和公开的数据集中提取签名；（ii）我们以**不同的方式触发事件**，即使用本地和远程智能手机，以及使用家庭自动化系统。
5）它们可以从**未加密**的和**加密**的流量中提取。
6）它们允许**快速**检测事件，因为它们只依赖于一些数据包的长度和方向，并且不需要任何统计计算。

**包级签名的自动提取。**我们提出PINGPONG，一种方法和软件工具。
(1)自动提取数据包级的签名，而**不需要事先了解设备的情况**；(2)检测网络痕迹和真实网络流量中的签名。**为了提取签名，PINGPONG首先通过反复触发需要签名的事件来生成训练数据，同时捕捉网络流量。接下来，PINGPONG在每个流量中提取请求-回复数据包对（"PING-PONG"），对这些数据包对进行聚类，并对其进行后处理，尽可能将数据包对串联成较长的序列。最后，PINGPONG选择频率接近触发事件数量的序列作为最终签名。**PINGPONG的签名检测部分利用了包级签名的简单性，并使用简单的状态机实现。PINGPONG的实现和数据集可在[49]中获得。

# 相关工作

## IoT设备标签

Apthorpe等人的一系列论文[10]-[13]使用基于流量/形状的签名来推断物联网设备的活动，但不能总是确定事件的确切类型。

OConnor等人的HomeSnitch[33]使用与我们类似的关键观察来**识别物联网活动**，即客户端（物联网设备）和服务器轮流进行**请求-回复通信方式**。HomeSnitch和PINGPONG都将I**P地址、端口号和DNS信息排除在其事件推断方法之外**，但在其使用的特征的粒度方面有所不同。HomeSnitch使用来自整**个客户-服务器对话的统计数据，而PINGPONG则考虑每个单独数据包的方向和长度**。HomeSnitch使用的最重要的特征是**每回合**从**物联网设备发送至服务器的平均字节数**。这一结果与本文的主要观察结果一致，即**单个请求（和回复）的数据包长度可以唯一地识别设备事件。**

Ren等人（IMC 2019）最近的一篇论文[39]提出了对物联网设备的大规模测量研究，并揭示了这些设备在美国和英国的运作方式在接触的互联网终端、私人信息的暴露等方面的不同。我们使用该数据集来评估我们在第五至第六节的方法。本文还提出了一个分类器，可以**推断出跨越许多设备类别的事件类型**；然而，这并不是本文的重点。

大多数事件推断技术依赖于机器学习[29]、[44]、[45]或流量时间序列的统计分析[3]、[19]、[33]、[39]。这些方法的局限性包括：无法区分事件类型[29]、[44]、[45]（例如，区分开和关），以及对流量整形技术[3]、[19]、[33]、[39]，如[10]缺乏抵抗力。另一方面，我们的工作**确定了设备/智能手机和云之间简单的数据包交换，可以唯一地识别事件类型**。同时，PINGPONG的分类性能（召回率超过97%）优于大多数统计方法。

PINGPONG也使用**聚类来识别重复出现的数据包对**，但对这些数据包对提供了一个直观的解释：它们对应于一个请求和随后的回复。

### 用到一些公开数据集

其他著名的测量研究和公开可用的**物联网网络流量数据集包括YourThings[5]、[6]和[45]，**我们在V-C节的评估中使用了这些数据。

## 物联网以外的网络流量分析

网络测量界有大量的工作，使用流量分析对应用程序进行分类并识别异常情况、或恶意软件。

于这些例子，底层协议是很好理解的，而PINGPONG可以与**任何任意的，甚至是专有的应用层协议一起工作（并且不受影响）**。

## 防御措施

与剖析和指纹相关的还有关于混淆流量签名的防御工作。例子包括[31]，[36]，使用数据包填充和流量注入技术来防止网站的指纹识别。在表一中，我们提到了两种一般的防御方法：（1）流量整形，泛指随着时间的推移改变流量的形状；以及（2）VPN，我们部分地评估了这些防御措施（见[48]的附录C）。

# 问题设置

首先介绍了我们的威胁模型。然后，我们介绍了智能家居环境和我们考虑的被动推理攻击。我们还讨论了我们从手动分析最简单的设备--智能插头的网络流量中获得的**一个关键见解**。我们在智能插头中观察到的数据包序列**启发**了自动提取签名的PINGPONG方法。

## 威胁模型

关注的是智能家居设备的网络流量泄露了关于智能家居设备和用户的私人信息。加密，但**信息可以通过流量元数据（如这些加密数据包的长度和方向）泄露出来。**

考虑两种不同类型的对手：一个**广域网嗅探器**和一个**Wi-Fi嗅探器**。这些对手在检查流量的有利位置方面有所不同。

- **广域网上的嗅探器**

监测**家庭路由器和ISP网络（或更远）之间**通信的网络流量[10]-[13]。这个对手可以检查所有数据包的IP头，但**不知道设备的MAC**地址来识别哪个设备发送了流量。我们假设一个**使用NAT的标准家庭网络**：所有来自家庭的流量都被复用到路由器的公共IP地址上。这种对手的例子包括情报机构和ISP。

- **Wi-Fi嗅探器**

监测加密的IEEE802.11流量，并没有被广泛研究[10], [23]。我们假设Wi-Fi嗅探器不知道WPA2密钥，因此只能获得以明文发送的信息--MAC地址、数据包长度和时间信息。由于数据包是加密的，Wi-Fi嗅探器无法获得网络和传输层信息。

对于这两个对手，我们**假设对手知道他们希望监测的智能家居设备的类型。**因此，他们可以**在另一个相同类型的设备上离线训练系统，提取设备的签名，并对来自他们目标智能家居的流量进行检测**。我们假设这些设备对它们的通信进行了加密，因此任何一个对手都**无法获得明文通信**。

## 智能家居环境和实验测试平台

![](../../../typora pictures/QQ截图20220407133810.png)

16个不同供应商的19个智能家居设备。

"Wi-Fi设备 "是任何通**过Wi-Fi连接到路由器**的智能家居设备（例如，亚马逊和WeMo插头）。

"以太网设备 "是任何**通过以太网（网线）连接到路由器**的智能家居设备（例如转发Zigbee通信的SmartThings枢纽）。

当智能手机连接到远程网络时，只有设备-云的通信在本地网络中可以观察到：智能手机通过与供应商的特定云通信来控制设备，而云将命令转发给设备。

此外，房子里还有其他计算设备（如笔记本电脑、平板电脑、手机），它们也会产生网络流量，我们称之为 "背景流量"。

我们在路由器的WAN接口（**eth0**）和本地接口（**wlan1和eth1**）上运行tcpdump，**捕捉互联网流量以及所有Wi-Fi和以太网设备的本地流量**。我们使用该测试平台为每个设备生成训练数据，然后从中提取签名。

## 通信

智能家居设备事件可能导致三对不同的设备之间的通信，如图1所示：（1）智能手机和智能家居设备（手机-设备）；（2）智能家居设备和互联网主机（设备-云），以及（3）智能手机和互联网主机（手机-云）。被动推理攻击背后的想法是，这**三条通信路径中的任何一条的网络流量可能包含独特的流量特征，可以利用这些特征来推断事件的发生。**

作为一个说明性的例子，让我们讨论我们对3个智能插头的人工分析：TP-Link插头、D-Link插头和SmartThings插头。

手动分析的数据是通过图1的设置收集的。对于每个设备，我们将其打开，等待大约一分钟，然后将其关闭。这个过程重复了3次启动和3次关闭，中间相隔1分钟。每个事件的时间戳都是手动记录的。在路由器上记录的PCAP文件是用脚本和Wireshark的手动检查相结合来分析的。

![](../../../typora pictures/微信截图_20230108191845.png)

我们确定了每个事件发生后立即出现的流量，并观察到在每个开/关事件之后都有**特定长度和方向的数据包对**，**同样的数据包对始终出现在同一类型的所有事件中（例如，开），但在不同的事件类型（开与关）中略有不同。**这些对是由一个方向的请求包和一个相反方向的回复包组成的。直观地说，这是有道理的：如果智能家居设备改变了状态，这一信息需要被发送到（请求），并由云服务器确认（回复），以使没有连接到家庭网络的设备能够查询智能家居设备的当前状态。

**关键启示**。这一初步分析表明，**每种类型的事件都是由特定长度的数据包对（或更长的序列）的交换来唯一识别的。**据我们所知，这种类型的网络签名以前还没有被观察到，我们把它称为包级签名。

# PINGPONG

从上一节我们知道：智能插头上的简单事件（例如，开与关）之后，通常有独特的数据包长度序列（对于数据包对或更长的数据包序列），并有可能被利用作为推断这些事件的签名。

这一观察促使我们研究：（1）更多的智能家居设备，以及可能控制它们的智能手机，是否在**事件发生后**表现出**自己独特的数据包级序列**，（2）这些**签名可以被学习和自动提取**，以及（3）它们是否**足够独特以准确检测事件**。

PINGPONG能**自动收集训练数据、提取数据包级的签名，并检测网络跟踪中签名的出现情况**。PINGPONG有两个组成部分。(1) 训练（第四章A节），和(2) 检测（第四章B节）。图2左侧显示了PINGPONG的构件和流程。

## 训练

它由5个步骤组成（见图2）。
**数据收集**。生成签名的第一步是收集设备的训练集。训练集是一个网络跟踪（PCAP文件），它包含了设备和智能手机作为事件结果产生的网络流量；这个跟踪伴随着一个文本文件，包含了一系列的事件时间戳。

用脚本控制官方安卓应用，比如触发开和关事件。脚本对每个特定事件发出n次对应的触摸序列，每次间隔m秒。

(1) 在路由器的接口上启动tcpdump；(2) 启动脚本；(3) 在发出第n个事件后终止tcpdump。这给我们留下了**一组PCAP文件和事件时间戳**，它们构成了我们的原始训练集。

由于**签名完全基于数据包的长度和方向**，互联网流量（即设备-云和电话-云流量）中的**签名适用于路由器的广域网侧**，尽管我们的签名生成基于从路由器本地接口收集的。

**流量过滤**。丢弃与用户操作智能家居设备无关的流量。所有的数据包，如果来源和目的地的IP与设备或控制的智能手机的IP不匹配，就会被丢弃。

接下来，我们通过从P中的数据包形成数据包对来构建集合P！。这是由下面的观察所激发的：构成数据包级签名的确定性数据包序列往往源于设备、智能手机和一些互联网主机之间的请求-回复交换（见第三节C）。此外，由于数据包对是最简单的可能模式，并且由于更长的模式（即数据包序列--见定义IV.2）可以从数据包对中重建，我们在训练集中寻找这些数据包对。对于图2中的TP-Link插头的例子，PINGPONG重新组合了<..., C-556, S-1293, ...>。 <..., C-237, S-826, ...>，等等，作为TCP连接。然后，PINGPONG提取<C-556, S-1293>、<C-237, S-826>等作为数据包对。

**数据包对聚类**。在形成一组数据包对之后，接下来**必须将相关的数据包对（即那些在一个事件之后持续出现的数据包）与不相关的数据包对分开。**这种选择还需要考虑到潜在的相关数据包对在长度上可能有轻微的变化。由于我们事先不知道数据包对中的长度，我们使用了一种无监督的学习算法。DBSCAN[22]。

DBSCAN的参数是E和minPts，它们分别规定了确定核心点时要考虑的邻域半径和该邻域中一个点成为核心点的最小数量。我们选择E=10，minPts=n 0.1n，其中n是事件的总数。

**创建签名。**放弃了所有频率不在[ n 0.1n , n + 0.1n ]区间内的集群，以便在签名中只包括那些频率与事件数量n紧密一致的集群。将集群中的数据包对连接起来，以便重新组合可能的最长的数据包序列（见定义IV.2），这增加了签名是唯一的几率。对一些设备的人工检查表明，**较早的序列往往是来自互联网主机的控制命令，然后是设备对该命令的确认，而较晚的序列将来自设备与其他一些互联网主机的通信，以通知该主机其状态的变化。**

**签名验证。**如果PINGPONG检测到最多n个事件，并且检测到的事件的时间戳与训练期间记录的事件的时间戳相匹配，则该签名被最终确定为有效的包级签名（见定义IV.5）并存储在签名文件中。如果一个签名检测到的事件多于训练集中的实际事件数（即假阳性），则无法通过这一检查。

**签名检测。**PINGPONG将 network trace视为数据包流，并将每个单独的数据包呈现给一组状态机。为每个流的签名的每个数据包序列维护一个状态机，即广域网嗅探器的TCP连接或Wi-Fi嗅探器的第2层流。一个数据包只呈现给与该数据包相关的流相关的状态机。如果数据包与建模的数据包序列中的下一个数据包（在长度和方向方面）相匹配，则状态机将推进到下一个状态；状态机对不符合预期的下一个数据包的反应是不同的，这取决于检测是在第2层还是第3层应用。对于第2层，这种数据包被简单地忽略，而对于第3层，这种数据包会导致状态机丢弃当前的部分匹配。当一个状态机达到其终端状态时，数据包序列匹配被报告给一个二级模块。这个模块等待签名的每个数据包序列的匹配，并在最后宣布签名匹配之前验证序列间的时间约束。

## 评估

A.从智能家居设备中提取签名

​	**训练数据集。**为了评估数据包级签名的通用性，我们首先使用PINGPONG自动收集所有19个智能家居设备（见表二）的训练集（见第四章A节）。训练集是在没有任何背景流量的情况下为每个被测设备单独收集的（见图1）。自动化脚本为设备生成了总共100个事件。对于具有二进制值的事件，脚本为每个事件类型生成**n = 50个事件**（例如，50个开启和50个关闭事件）。对于具有连续值的事件，脚本生成n = **100个事件**（例如， Sengled灯泡的100个强度事件）。对于每个训练集，我们用PINGPONG为各自设备的每个事件类型提取包级签名（见IV-A节）。总之，PINGPONG提取了18个设备的签名（见表四）。这些签名跨**越了广泛的事件类型：二进制（例如，开/关）和非二进制（例如，灯泡强度，颜色等）。**

​	**结果总结。**用PINGPONG为各自设备的每个事件类型提取包级签名。