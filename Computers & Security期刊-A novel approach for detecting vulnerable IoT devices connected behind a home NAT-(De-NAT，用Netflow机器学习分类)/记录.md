提出了一种基于**机器学习**的方法，该方法可以检测连接在**国内NAT后面**（domestic NAT）的特定易受攻击的物联网设备模型，从而识别对电信公司基础设施和服务可用性构成风险的家庭网络。

从实验室的各种商用物联网设备收集了大量网络流量数据，并比较了几种分类算法。我们发现（a）**LGBM**算法产生了出色的检测结果，（b）我们的基于流的方法是鲁棒的，可以处理用于识别NAT后面的设备的现有方法**无法完全寻址**（fully address）的情况，例如，加密的、非TCP或非DNS流量。

分享了我们新的标记基准**数据集**。

# 简介

背景：根据Krebs（2016）的说法，此次攻击**依赖于利用特定型号**的易受攻击且安全性较差的互联网连接摄像头和其他物联网设备的安全漏洞。

我们考虑了电信公司在防御从其客户场所发起的基于物联网的攻击时使用的额外措施，并提出了一种在受到威胁之前检测连接的易受攻击的物联网型号的方法。该方法采取先发制人的方式，可以帮助电信公司识别其网络的潜在威胁，并使其能够及时采取预防措施。我们的方法分别监控每个智能家庭的流量，以验证特定的物联网型号是否连接到家庭网络，这些型号已知容易被恶意软件利用以执行网络攻击。

家庭网络通常使用具有NAT（网络地址转换（Egevang等人，1994））功能的网关路由器，为了减少公共IP地址的数量，将每个出站分组的本地（私有）源IP地址替换为路由器的全局唯一公共IP地址。因此，由于NAT后连接的所有不同主机产生的出站流量都用相同的源IP地址（即路由器的地址）标识，因此**从网络外部检测连接的物联网模型是一项具有挑战性的任务**（**参见第3.1节**）。通过使用我们提出的方法，电信公司可以（1）检测NAT后连接到的易受攻击的物联网设备，以及（2）使用该信息采取行动。

本质上，对于每个易受攻击的物联网模型，我们建议（a）收集流级流量元数据，（b）以集中方式训练基于机器学习的分类器，然后（c）使用本地检测器部署分类器，每个检测器都监控智能家居，一旦检测到易受攻击物联网设备的存在，可以采取措施降低风险。

```
(a) collect flow level traffic metadata, (b) train a machine learning-based classifier in a centralized manner, and then (c) deploy the classifier using local detectors, each of which monitors a smart home and can take steps to mitigate the risk once it detects the existence of a vulnerable IoT device.
```

论文的贡献总结如下：

- 不依赖于在计算和存储方面相对侵入和低效的分组级分析（Sivanathan等人，2016）。与深度数据包检查（DPI）相反，我们使用紧凑的流级别统计（根本不分析有效负载）。此外，我们的方法在**单个流量水平上**运行（individual flow level），并且仍然提供优异的检测性能。
- 尽管已经提出了几种方法来**分析NATed流量**，但其中只有少数方法（Guo，Heidemann，2018，Li，Zhu，Liu，Zhou，Guo，2019）解决了物联网设备识别的挑战。此外，我们根据经验表明，我们的方法是稳健的，并且在现有方法仅部分适用的情况下表现良好，例如，加密、非TCP或非DNS流量。
- 我们使用大量时间内从各种商用家庭物联网设备收集的真实流量数据对我们的方法进行了实证评估，并证明我们可以快速准确地检测NAT背后的物联网模型。与过去的一些研究不同，这些研究使用部分、有疑问或完全未标记的数据集或仅一种类型的设备来评估他们的方法（Li等人，2019），我们的数据是多功能的，并明确**标记了设备model**。

# 研究范围

在这项研究中，我们专注于检测NAT后易受攻击的物联网模型与国内网络的连接，我们建议分别为每个易受攻击的物联网模型训练分类器，并使用训练的分类器在智能家居中进行检测。请注意，我们只**关注潜在有害连接的检测**，而不是所有连接设备的完整分类或映射。也就是说，为了降低风险，我们只想**知道易受攻击的物联网模型是否连接在NAT之后**。如果没有足够的证据证明存在易受攻击的物联网模型的连接，那么无论是否连接了物联网，连接的设备对我们来说都无关紧要。

在本研究中，我们专注于智能家居，这是一个持续增长的市场（技术委员会，2018年），更具体地说，我们将本研究的范围限制为通过**Wi-Fi或以太网直接连接**到路由器的物联网模型。这些物联网模型的网络流量更容易（a）从国内网络外部大规模捕获和监控（与蓝牙或ZigBee不同），以及（b）直接配置，因为这些物联网模式不通过智能手机或多用途控制器连接。此外，我们关注的物联网模型已经用于现实世界中的网络攻击（例如，网络摄像头套件，Krebs）或研究（例如，智能灯泡Ronen和Shamir，2016）。

# 假设

## 物联网model的定义

使用四个元素的组合来定义物联网模型：

1)类型：网络摄像头、灯泡、插座等。

2)制造商：D-Link、TP-Link、Efergy等。

3)型号：DCS-942L、LB130、eGo等。

4)固件版本。

例如，TV.SSamsung.UE55D7000.（未公开的固件版本）是一种物联网模型，已发现其易受Mirai僵尸网络变体（2018年春季）的攻击，

## 网络连接假设

我们假设一个典型的设置：物联网设备连接到网关路由器，主要通过Wi-Fi。该路由器提供了一个接口，用于将启用IP的设备连接到Internet，并且具有NAT功能。

电信公司是一个被动的倾听者，它观察来自NATed客户场所的流量。此外，我们假设电信公司在监控流量时不知道哪些应用程序正在运行。

## NATed设备的可用性

如果Mirai的扫描仪为端口22/23启用了端口转发，则Mirai的扫描仪能够扫描配置了IP地址的NATed设备。*打孔*（[Shaked，2019](https://www.sciencedirect.com/science/article/pii/S0167404820302418#bib0084)）是外部实体可以使用NAT到达网络上所需客户端的另一种方法。 因此，在这项研究中，我们假设即使某些物联网模型连接到NAT后面的家庭网络，也可以利用它们。然后，基于这一假设，我们专注于开发一种方法，使用[网络流量分析](https://www.sciencedirect.com/topics/computer-science/network-traffic-analysis)来检测此类易受攻击的物联网模型的连接。

# 背景和相关工作

## NATing

这使得物联网设备识别变得困难，因为作为NAT出站流量的一部分，NAT路由器通过用路由器的外部IP地址替换所有单独连接设备的内部IP地址来有效地“隐藏”它们。一旦NATed，**将每个数据包与其数据包流关联（从外部）就成为了一个真正的挑战**（什么挑战？不理解，即便NAT之后，流应该也是存在的，只是源IP和端口被替换了），从而破坏了现有物联网识别方法的有效性。

## deNATing

一些研究提出了去NATing的方法（Orevi等人，2017），这是NATing的反向作用。DeNATing本质上旨在**重新识别通过NAT的通信流**。一旦执行，DeNATing有助于后续基于流的分析，包括我们在本研究中讨论的物联网模型检测。在第3.3节和第3.4节中，我们调查了现有的deNATing方法，并根据我们的用例说明了它们的缺点。

与大多数现有方法不同，我们建议**使用流行的NetFlow协议进行去NATing**，因为它已经在内部将相关数据包聚合到流中。尽管**NetFlow实际上在某种程度上在内部执行去NATing**，但仅基于单个流的特定物联网模型的检测仍然是一个决定性的挑战。我们使用有监督的机器学习算法来解决这一挑战。

## NetFlow作为物联网流量分析的基础

在本文中，我们建议使用NetFlow（cisco.com，2017）作为物联网流量分析的基础。仅收集和分析NetFlow的统计聚合（即元数据）而不是原始数据，所需的计算和存储量大大减少，从而提高了分析效率。

它被公认为是**大流量紧凑表示的事实标准**。在学术文献中，NetFlow已用于安全相关任务，如僵尸网络检测和去NAT（Abt，Baier，2012，Guo，Heidemann，2018，Verde，Ateniese，Gabrielli，Mancini，Spognardi，2014）。

## 相关工作

表1总结了过去与去NAT和/或物联网识别相关的研究范围和方向。

如果它们专门解决了上述去NAT的挑战，表中**DeNAT**一项被划上了√；相比之下，如Gokcen等人（2014）和Khatouni等人（2019），涉及NATed流量的分析，但它们在这里不被视为去NAT论文，因为它们本身不执行去NAT。也就是说，**不是将NATed流量（都具有NAT路由器的相同公共源IP地址）划分为不同的数据包流以供进一步分析**，它们专注于识别网络中NAT设备的存在。

表1中列出的大多数deNAT论文旨在揭示NAT路由器背后连接的设备的身份和/或数量。

与先前的deNAT研究不同，我们的研究主题是操作系统（Orevi等人，2017）或人及其行为，我们的方法旨在**检测连接的设备**（易受攻击的物联网模型的实例）。与其他先前针对智能城市（Guo，Heidemann，2018年，Verde，Ateniese，Gabrielli，Mancini，Spognardi，2014年）和智能制造（Guo和Heidemmann，2018年）等大规模环境的deNAT相关研究相比，我们**针对智能家居定制**了我们的方法。

**我们发现，在物联网领域（通常基于Linux）执行去NATing的论文仅有Apthorpe等人（2017）、Guo和Heidemann（2018）和Li等人（2019）。然而，Apthorpe等人（2017）不涉及设备识别，而Guo和Heidmann（2018）以及Li等人（2019）在我们的用例中存在实质性缺陷，如下一小节所述。**

## 方法对比

显然，大多数方法都依赖于直接从TCP/IP模型中提取的特征。问题是，在某些情况下，这些方法可能无法解决我们的用例。例如，当流量**加密时，**来自应用层的功能，如HTTP user agent（Gokcen等人，2014）、MSN（Microsoft Network Messenger）事务ID（Ori等人，2008）和请求的DNS域（Apthorpe，Reisman，Feamster，2017，Li，Zhu，Liu，Zhou，Guo，2019）可能对电信公司不可用。

相反，我们使用NetFlow，它从不同的层（例如通常未加密的网络和传输层）提取数据，以及诸如流量和流量之类的元数据。

我们明确地用**设备model**的基本事实来标记我们的数据。

最重要的是，我们明确地用设备模型的基本事实来标记我们的数据。因此，我们认为，我们公开可用数据集的新颖性、真实性、多样性、范围和可靠性（Meidan等人，2020）将有助于未来的研究，并可能作为去NATing算法的基准，特别是在智能家居的背景下。

我们基于NetFlow的方法可以处理TCP和UDP，因此它可以在更长的时间内覆盖更广泛的物联网模型。其他方法严重依赖物联网设备与之通信的服务器（Apthorpe等人，2017）和相关DNS域（Guo和Heidemann，2018）。使用NetFlow，我们可以分析各种流量，而不仅仅是DNS等特定协议。一些先前的研究使用IP TTL（Maier等人，2011），基于NAT设备迭代递减其值1的假设。然而，不同NAT设备之间其递减的值可能不同，因此通用性可能较弱。

## 两个涉及NAT和设备识别的代表工作

在过去与去NAT和物联网设备相关的研究中，**只有Li等人（2019）和Guo和Heidemann（2018）提出了设备识别机制，正如我们所做的这样。**

- Li等人提出了“CamHunter”，这是一种识别NAT背后智能摄像头的三阶段方法。该方法（1）筛选可能包含智能摄像机的IP地址，（2）提取心跳向量，（3）从向量中生成指纹作为分类的基础。CamHunter的一个主要缺点在于它的第二阶段，即从连续数据包序列中提取心跳向量。当所有源IP和/或MAC地址都可见（未NAT）时，可以容易地识别多个连接设备的后续数据包。这就是Li等人（2019）如何训练他们的模型。然而，随着NAT背后的主机数量的增加（Guo，Heidmann，2018，Maier，Schneider，Feldmann，2011），**将数据包从单个设备分离成不同的流，**对于NAT另一侧（即电信公司）的被动侦听器来说，这是一个真正的挑战。事实上，**这是去NATing的一大挑战**（Orevi等人，2017），解决这一问题需要使用可能不够准确的附加方法，从而导致分组分组和排序不正确，进而导致特征计算不正确。

- Guo和Heidemann（2018，Detecting IoT Devices in the Internet，基于域名做的，之前让看过）建议基于通信的面向设备的制造商服务器名称（而非面向人或第三方）的每种类型列表来识别NATed IoT设备类型。这一想法类似于Li等人（2019）的基本逻辑，他指出，基于云的设备需要发送DNS请求以获取设备服务器的IP地址。由于不同的供应商提供不同的云平台，这些智能设备请求不同的域名，这些域名可用于基于网络的检测。

# 论文的方法

对于要检测的易受攻击的物联网模型列表中的每个项目，我们建议假设电信公司培训并部署基于机器学习的分类器，以检测各个物联网模型与客户（NATed）国内网络的连接。物联网设备检测的先决条件是维护由电信公司感兴趣的易受攻击物联网模型组成的检测列表。可作为此列表输入的两个成熟的在线资源是通用漏洞和风险（CVE）系统（Mitre，1999）和国家漏洞数据库（NVD）（NIST，2000）。

## 集中训练

1. 对于已被识别为潜在易受攻击的物联网模型，因此是检测列表的一部分，各个设备（即该物联网模型的实例）将被添加到中央实验室的网络中。
2. 在连接的设备正常使用时，网络流量数据生成并随后由安装在NAT路由器上的**NetFlow**处理。使用**nProbe** 连续收集生成的流，并将其存储在指定的服务器上，从而**累积原始流级别数据集**。
3. 训练该物联网模型的分类器（步骤3）。这包括：
   1. 数据预处理（编码、标准化、特征工程等）、
   2. 流标记（如果流是由给定的IoT模型生成的，则为真，否则为假）、
   3. 数据分区以及用于训练和微调分类器的机器学习技术的应用。
4. 我们建议使用**二进制（一对一）分类**算法。为了**确定分类器的分类阈值**，我们建议采用接近零误报（NZFP）的方法（Camiña等人，2019）。优化FP的原因是电信公司可能更倾向于处理少量的漏检，而不是处理对错误警报做出反应的不利影响。
5. 在实践中，我们建议将**分类阈值**设置为使用验证集生成NZFP的分类分数的值。电信公司可以确定“接近零”（例如0.00001）的确切值，从而考虑到其可以处理的FP和FN数量、物联网模型的安装基础以及即将发生的网络攻击的可能性等因素。

## 本地部署

我们建议使用本地代理来部署物联网模型分类器，尽管电信公司通常已经可以集中监控来自其客户家庭网络的所有数据包内容。这样做的主要原因是，中央监控解决方案可能会生成一个包含特定客户拥有的物联网设备信息的表。该表可能成为攻击者的一个有价值的目标（一次从多个家庭窃取信息）或成为单一故障点。

这些本地检测器监测从家庭网络中出现的（NATed）流量数据（步骤5），并应用预训练的物联网模型分类器，以便检测该模型的连接物联网设备并相应地做出响应（步骤6）。每个本地检测器可以使用低成本的瘦计算机（例如树莓派）来实现，并且应该具有以下软件组件：（1）用于从被监控的家庭网络收集流的nProbe ，（2）用于预处理流的软件环境（例如Python），（3）经过训练的分类器，以及（4）能够基于**分类结果**做出决策和执行动作（如第4.3节所述）的软件组件。

作为连续监控的一部分，由本地检测器从被监控家庭网络收集的每个流都会按照中央实验室的方式进行预处理，以实现相同的数据结构和规模。然后，**IoT模型分类器为每个流分配一个分数。为了确定该流是否由给定的物联网模型生成，将分类分数与分类阈值进行比较，该阈值的值使用验证集进行优化，以使错误检测最小化**（NZFP方法的经验评估见第6.4节）。

# 评估方法

## 实验环境

建立了一个专用网络，该网络代表NAT后连接的各种物联网和非物联网设备的真实场景。

首先，我们将交换机（Cisco Catalyst 2960-X，1G端口（Cisco，2019））划分为VLAN输入和VLAN输出，分别代表家庭网络侧和电信公司侧。然后，我们通过无线接入点将各种商用物联网设备以及笔记本电脑和智能手机连接到VLAN。我们还将VLAN连接到安装NetFlow的NAT路由器（Cisco 3825（Cisco，2006））。然后，我们将路由器连接到连接到互联网的VLAN输出。

此外，为了能够评估先前进行的deNAT相关研究（大多数研究依赖于数据包级别的数据而不是NetFlow记录），我们还从VLANin和VLANout执行了端口镜像，然后使用Wireshark捕获了pcap文件。

![Fig. 3](https://ars.els-cdn.com/content/image/1-s2.0-S0167404820302418-gr3.jpg)

## 数据集

1)初始：启动后立即进行设备设置

2)活动：用户交互（例如，网络摄像头查看）

3)空闲：无用户驱动流量的网络连接

与Li等人（2019）类似，我们选择将重点放在**空闲阶段**，在空闲阶段不存在人与人的交互，但物联网设备可能非常活跃，例如流视频或发送测量。关注空闲阶段的原因是物联网**设备大部分时间都处于这种状态**（即高覆盖率）。

我们收集了37天的NetFlow数据，在此期间，非物联网设备相当活跃（即，与之交互），而物联网设备大多处于空闲状态。我们认为这在很大程度上代表了智能家居，在智能家居中，笔记本电脑和智能手机被广泛使用，而插座或网络摄像头等智能设备则连接到网络，但很少与之交互。

## 特征提取

我们将nProbe配置为每小时输出一次*.flows文件，同时记录一个功能集，该功能集对于物联网模型检测来说是最小的，但可能提供信息。

表4概述了这些特征，解释了其内容，并提供了过去**使用这些（或等效）特征的deNAT和/或物联网识别相关研究**的参考。我们**按原样使用了这些特征中的大多数**（由复选标记表示），并为每个流添加了一些**派生特征**：

## Ground truth

在我们的实验室中，我们记录了NAT前后的流量。通过这种方式，我们能够将每个外部出站流量（标有路由器的公共源IP地址）与其内部孪生流量（标有设备的私有源IP地址的）进行匹配，

基于除以下之外的所有功能：

•

IPV4_SRC_ADDR（由NAT明确更改）

•

L4_SRC_PORT（可能由NAT更改）



•

FIRST_SWITCHED和LAST_SWITCHED（可能有一些小延迟）


我们还确保在路由器上配置静态IP，因此在找到每个流的私有源IP地址后，我们将其标记为正确的源MAC地址和IoT模型。由于物联网设备的固件在数据收集期间未发生变化，标签上的物联网模型仅包括前三个组件：类型、制造商和型号。作为这项研究的一部分，我们公开分享了这一标记数据集（Meidan等人，2020）。

## 数据预处理

## 实验

精确召回曲线下的区域（AUPRC）：如表3所示，我们捕获的数据中**存在严重的类别失衡**（出站流量计数），这意味着某些类别（即物联网模型）在我们的数据集中表现得比其他类别多得多。这种类不平衡与训练集和测试集有关（见表5），我们使用二元（一对一）方法来评估每个物联网model分类器。因此，正如Davis和Goadrich（2006）所建议的，我们使用AUPRC作为总结每个分类器分类性能的关键指标。

![](../../../typora pictures/微信截图_20221229204122.png)

## 实验结果

[GBDT、XGBoost、LightGBM的区别和联系 - 简书 (jianshu.com)](https://www.jianshu.com/p/765efe2b951a)

- LGBM
- DNN
- SVM

我们通过使用所有训练集（全部30天）训练上述分类算法，并使用所有测试集（其余7天）进行测试，获得了这些结果。

精确召回曲线下面积（AUPRC）：为了计算每个物联网模型的AUPRC，我们在scikit learn中使用了average_precision_score（）函数（Pedregosa等人，2011）。表5中的结果表明，LGBM（0.99±0.017）在AUPRC方面优于DNN（0.967±0.044）和SVM（0.89±0.139）。

由于LGBM展示了最大的AUPRC，它在准确度和召回率之间提供了最佳的权衡，因此电信公司可能会首选LGBM。

## 特征重要程度

表7中所示的信息显示了LGBM分类器中特征的重要性，以特征在分类器中使用的次数计算。

如图4所示，LGBM发现最重要的这些特征在所检查的物联网和非物联网设备模型中的分布确实不同：图4a和图4c分别显示了DURATION和in_BYTES特征的不同中值、四分位数范围和异常值数量。图4b表明，正如人们所预期的，对于某些设备模型，L4_SRC_PORT的分布是均匀的，但是对于其他设备模型，分布并不完全如此。

## 超参数tuning

## 分类阈值的优化

## 现有的主要去NATing方法对我们用例的适用性

### DNS请求中的域名

我们在物联网中发现的关于去NATing的所有三篇论文（即，我们用例的特定上下文）都使用了DNS请求中的域名（Apthorpe，Reisman，Feamster，2017，Guo，Heidemann，2018，Li，Zhu，Liu，Zhou，Guo 2019）。这些论文依赖于这样一个概念，即物联网设备与PC和智能手机不同，通常由其制造商运行的独特服务器定期交换流量。

同时，这些论文还承认与依赖所请求的域相关的相当大的缺陷，例如，生成和维护设备特定的域列表、重叠的通信域等方面的**大量开销**（见第3节）。例如对《DNS-DNS: DNS-Based De-NAT Scheme》这个工作，要根据域名识别IoT，要达到阈值就**需要采集相当长时间，才能得到足够多的DNS流量**。

此外，由于**流量加密，首先需要考虑所请求域名的可用性**。

根据经验，基于我们在实验室中捕获的流量，大多数物联网设备请求一组相当小且独特的域名，不同物联网设备之间的域名重叠程度有限。这在图6中表示为相对不同的域名集群和请求它们的相应物联网模型。事实上，在流量捕获期间，四个物联网模型请求了完全不同的域名。这一发现证实了物联网设备定期与服务器通信的概念，从而支持将该方法用于物联网模型检测。另一方面，剩余的IoT在请求的域名中显示出轻微的重叠，此外，从图7中可以看出，由于加密，对该方法的基本数据源（即DNS请求的内容）不可用的担忧是现实的。

### 使用应用层数据

应用层功能的主要缺点是，在流量被加密的情况下，它们变得不可用，从而损害了IoT模型的检测范围。

### DNS请求中的IP-ID

正如Orevi等人（2017）所指出的，在一些操作系统中，从主机到固定目标IP（例如，到其DNS解析器）的后续数据包中的IP ID字段通常递增1，包括Windows 8和10以及Android。这种行为允许NAT另一侧的被动侦听器识别相关数据包的不同集群，使用额外的数据源（如TCP时间戳）创建数据包序列，然后执行进一步的分析（可能是物联网识别）。然而，Windows和Android在物联网中相对少见，因此必须验证稳步增长，以确定基于DNS IP ID的物联网去NATing的可行性。

### TCP时间戳

这个时间戳可以在TCP数据包的报头上找到，已经在去NATing背景下的一些先前研究中使用，例如，Orevi等人（2017）；Tekeoglu等人（2011）。在消费者物联网设备中常见的操作系统Linux中，TCP时间戳在启动时设置为零，并每隔10毫秒定期递增。Tekeoglu等人（2011）的作者提出了时间线与TCP时间戳的关系，作为区分NATed主机的流量流的一种方法，然而，即使他们也注意到，这条线实际上不是线性的，并且非常容易出错。此外，如图9所示，在我们的实验中，3/6的物联网设备中，TCP协议用于不到30%的出站数据包。这意味着在剩余的数据包中，TCP时间戳不可用，因此无法使用此功能对这些物联网设备进行去NAT。相反，我们的方法可以很好地处理任何流，无论它使用TCP、UDP还是ICMP。

# 结论和未来研究

我们提出了一种检测连接到家庭网络的可利用物联网设备的方法，由于NAT启用路由器网关的典型使用，这种情况对现有物联网识别技术提出了挑战。NAT流量使基于流的分析变得更加困难，因为同一设备生成的数据包很难相互关联。为了减轻上述风险并**有效地执行IoT去NATing，我们建议使用流行的NetFlow协议，因为NetFlow**（1）已经在内部将相关数据包聚合成流，（2）节省计算和存储，（3）避免检查有效负载，以及（4）启用检测，即使是非TCP、非DNS和加密流量。我们证明，通过使用不超过一个流程，我们基于LGBM的方法能够检测出平均AUPRC为（0.992±0.014）的易受攻击物联网模型。
